name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --frozen

      - name: Run linter
        run: uv run ruff check src/pretix_race/

      - name: Run type checker
        run: uv run mypy src/pretix_race/

      - name: Run tests
        run: uv run pytest -v

  headless-smoke-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --frozen

      - name: Test CLI help
        run: uv run pretix-race --help

      - name: Test headless flag is recognized
        run: |
          uv run pretix-race --url https://example.com --event test --headless --help 2>&1 | grep -q "headless"
          echo "Headless flag recognized"

      - name: Verify platform detection (Linux)
        run: |
          python3 -c "
          from src.pretix_race.config import _default_user_agent, _default_sec_ch_ua_platform
          ua = _default_user_agent()
          platform = _default_sec_ch_ua_platform()
          assert 'Linux' in ua, f'Expected Linux in user agent: {ua}'
          assert 'Linux' in platform, f'Expected Linux in platform: {platform}'
          print(f'User-Agent: {ua}')
          print(f'Platform: {platform}')
          "

  docker-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t pretix-race .

      - name: Test Docker image help
        run: docker run --rm pretix-race

      - name: Verify headless mode in Docker
        run: |
          docker run --rm pretix-race --url https://example.com --event test 2>&1 | head -10
